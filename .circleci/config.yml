version: 2.1

# docker:
#   - image: circleci/node:12.14.1
#     environment:
#       NODE_ENV: test
#       TEST_DB_HOST: 127.0.0.1
#       TEST_DB_NAME: circle_test
#       TEST_DB_USERNAME: ubuntu
#       TEST_DB_PASSWORD: ''
#   - image: circleci/postgres:9.6
#     environment:
#       POSTGRES_USER: ubuntu
#       POSTGRES_DB: circle_test
#       POSTGRES_PASSWORD: ''

jobs:
  build:
    working_directory: ~/repo
    steps:
      - checkout

      - run: sudo npm install

      - save_cache:
        key: disposables-cache-1-{{ checksum "package-lock.json" }}
        paths:
          - ./node_modules

      - run: ./node_modules/.bin/sequelize db:migrate

      - run:
        name: Setup Code Climate test-reporter
        command: |
          # download test reporter as a static binary
          curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
          chmod +x ./cc-test-reporter

      - run:
        name: Run tests
        command: |
          ./cc-test-reporter before-build
          npm test --coverage-clover clover.xml
          ./cc-test-reporter after-build --coverage-input-type clover --exit-code $?
